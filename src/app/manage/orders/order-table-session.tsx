/* eslint-disable @typescript-eslint/no-explicit-any */
"use client";
import { GetOrdersResType } from "@/schemaValidations/order.schema";
import { useState } from "react";
import { OrderModeType, OrderStatus, OrderStatusType, OrderStatusValues } from "@/constants/type";
import { Tabs, TabsList, TabsTrigger } from "@/components/ui/tabs";
import OrderList from "@/app/manage/orders/order-list";
import TableSessionList from "@/app/manage/orders/table-session-list";
import { useGetOrderQuery } from "@/queries/useOrder";
import { endOfDay, startOfDay } from "date-fns";
import { useGetListTableQuery } from "@/queries/useTable";
import { TableListResType } from "@/schemaValidations/table.schema";
import { useOrderService } from "@/app/manage/orders/order.service";

export type StatusCountObject = Record<(typeof OrderStatusValues)[number], number>;
export type Statics = {
  status: StatusCountObject;
  table: Record<number, Record<number, StatusCountObject>>;
};
export type OrderObjectByGuestID = Record<number, GetOrdersResType["data"]>;
export type ServingGuestByTableNumber = Record<number, OrderObjectByGuestID>;

function checkStatus(status: OrderStatusType) {
  const arr = [OrderStatus.Pending, OrderStatus.Processing, OrderStatus.Delivered];
  return arr.includes(status as any);
}

const initFromDate = startOfDay(new Date());
const initToDate = endOfDay(new Date());
export default function OrderTableSession() {
  const [selectedTabPage, setSelectedTabPage] = useState<string>("orders");
  const [fromDate, setFromDate] = useState(initFromDate);
  const [toDate, setToDate] = useState(initToDate);

  const tableListQuery = useGetListTableQuery({
    pagination: "false",
    page: 1,
    limit: 5, // nếu pagination = false thì page và limit không có ý nghĩa
  });
  const tableList: TableListResType["data"] = tableListQuery.data?.payload.data ?? [];

  const { data, refetch, isPending } = useGetOrderQuery({
    fromDate: fromDate,
    toDate: toDate,
  }); // fetch order list ngày hôm nay (mặc định)
  const orderList: GetOrdersResType["data"] = data?.payload.data ?? [];

  const tableListSortedByNumber = tableList.sort((a, b) => a.number - b.number);

  const { statics, servingGuestByTableNumber } = useOrderService(orderList);

  const countTotalTableSession = Object.keys(servingGuestByTableNumber).length;
  const countOrderDineInByTab = orderList.filter(
    (order) => order.orderMode === OrderModeType.DINE_IN && checkStatus(order.status),
  ).length;
  const countOrderTakeOutByTab = orderList.filter(
    (order) => order.orderMode === OrderModeType.TAKE_OUT && checkStatus(order.status),
  ).length;
  const countTotalOrder = countOrderDineInByTab + countOrderTakeOutByTab;

  return (
    <div>
      <Tabs value={selectedTabPage} onValueChange={(val) => setSelectedTabPage(val)} className="mb-4">
        <TabsList variant="default">
          <TabsTrigger value={"orders"}>
            <span>Đơn hàng</span>
            <span className="bg-red-500 w-4 h-4 text-center inline-block rounded-full text-xs">
              {countTotalOrder}
            </span>
          </TabsTrigger>
          <TabsTrigger value={"table-sessions"}>
            <span>Phiên bàn</span>
            <span className="bg-red-500 w-4 h-4 text-center inline-block rounded-full text-xs">
              {countTotalTableSession}
            </span>
          </TabsTrigger>
        </TabsList>
      </Tabs>

      {selectedTabPage === "orders" && (
        <div className="mt-4">
          <OrderList
            orderList={orderList}
            refetch={refetch}
            isPending={isPending}
            fromDate={fromDate}
            setFromDate={setFromDate}
            toDate={toDate}
            setToDate={setToDate}
            statics={statics}
            countOrderDineInByTab={countOrderDineInByTab}
            countOrderTakeOutByTab={countOrderTakeOutByTab}
          />
        </div>
      )}

      {selectedTabPage === "table-sessions" && (
        <div className="mt-4">
          <TableSessionList
            statics={statics}
            tableListSortedByNumber={tableListSortedByNumber}
            servingGuestByTableNumber={servingGuestByTableNumber}
          />
        </div>
      )}
    </div>
  );
}
